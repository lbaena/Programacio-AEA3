on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-test-publish:
    name: Build ${{ matrix.project }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: [ "01-Colors", "02-LlibreriaFitxers", "03-agendaCSV" ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Build with Gradle
        run: |
          cd ${{ matrix.project }}
          chmod +x gradlew
          ./gradlew assemble

      - name: Run Tests
        run: |
          cd ${{ matrix.project }}
          ./gradlew check

      - name: Generate Javadoc
        run: |
          cd ${{ matrix.project }}
          ./gradlew javadoc

      - name: Publish Artifacts
        if: github.ref == 'refs/heads/master'
        run: |
          cd ${{ matrix.project }}
          ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    needs: build-test-publish
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Consolidate Javadocs
        run: |
          mkdir -p public/01-Colors public/02-LlibreriaFitxers public/03-agendaCSV
          # Nota: Esto asume que generas los docs antes o los sacas de artefactos
          # Para simplificar, generamos el "index" general aqu√≠ si quieres
          echo "<html><body><h1>Projectes documentats javadocs</h1><ul><li><a href='./01-Colors/'>Colors</a></li></ul></body></html>" > public/index.html
